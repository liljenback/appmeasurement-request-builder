<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<!-- Kudos for looking at the source!                                 -->
<!--                                                                  -->
<!-- Accessible variables on this page:                               -->
<!--   s - tracker object (where all your request data is set on).    -->
<!--                                                                  -->
<!-- If you view the network tab in Chrome you can see the request    -->
<!-- being sent, and also copy the request as a curl command by       -->
<!-- right clicking on the request and select "Copy as cURL".         -->
<!-- This way you can send the request from your terminal as well.    -->

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AppMeasurement Request Builder</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <script src="src/AppMeasurement.js"></script>
</head>

<body>
  <!-- Place holder for enabling a more detailed settings screen -->
  <!-- <div style="position: fixed; top: 0; right: 5%; padding: 10px;">
    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#settings">
      ⚙️ Settings
    </button>
  </div> -->
  <div class="modal fade" id="settings" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">Modal title</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          ...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Understood</button>
        </div>
      </div>
    </div>
  </div>

  <script language="JavaScript">

    let extraInputDiv = "extraInputs";

    // TODO: Keep old fields around in local storage
    let fields = {};

    const addNewTextInput = (inputDetails) => {
      // Set default values if properties are not provided
      const id = inputDetails.id || "";
      const label = fieldInfo[id]["name"] || "";
      const value = inputDetails.value || "";
      const placeholder = fieldInfo[id]["placeholder"] || "";

      // Create the necessary elements
      const formGroup = document.createElement("div");
      formGroup.classList.add("mb-3");

      const labelElement = document.createElement("label");
      labelElement.textContent = label;
      labelElement.setAttribute("for", id);
      labelElement.classList.add("form-label");

      const textInputDiv = document.createElement("div");
      textInputDiv.classList.add("input-group");

      const inputElement = document.createElement("input");
      inputElement.setAttribute("type", "text");
      inputElement.setAttribute("value", value);
      inputElement.classList.add("form-control");
      inputElement.setAttribute("id", id);
      inputElement.setAttribute("placeholder", placeholder);

      const helpElement = document.createElement("div");
      helpElement.classList.add("form-text");
      helpElement.classList.add("text-muted");
      helpElement.innerHTML = fieldInfo[id]["help"] + " " + `<a href="${fieldInfo[id]["url"]}" target="_blank">.. learn more</a>`;

      const deleteButton = document.createElement("button");
      deleteButton.classList.add("btn");
      deleteButton.classList.add("btn-outline-secondary");
      deleteButton.setAttribute("type", "button");
      deleteButton.textContent = "X";

      // Add delete functionality
      deleteButton.addEventListener("click", function () {
        formGroup.remove();
      });

      textInputDiv.appendChild(deleteButton);
      textInputDiv.appendChild(inputElement);

      // Append elements to form group
      formGroup.appendChild(labelElement);
      formGroup.appendChild(textInputDiv);
      formGroup.appendChild(helpElement);

      // Append form group to the specified div
      const extraInputsDiv = document.getElementById(extraInputDiv);
      extraInputsDiv.appendChild(formGroup);
    };

    const addNewMultiInput = (inputDetails) => {
      // Set default values if properties are not provided
      const id = inputDetails.id || "";
      const label = fieldInfo[id]["name"] || "";
      const value = inputDetails.value || "";
      const placeholder = fieldInfo[id]["placeholder"] || "";

      // Create the necessary elements
      const formGroup = document.createElement("div");
      formGroup.classList.add("mb-3");

      const labelElement = document.createElement("label");
      labelElement.textContent = label;
      labelElement.setAttribute("for", id);
      labelElement.classList.add("form-label");

      const textInputDiv = document.createElement("div");
      textInputDiv.classList.add("input-group");

      const numberInputElement = document.createElement("input");
      numberInputElement.setAttribute("type", "number");
      numberInputElement.setAttribute("max", "100");
      numberInputElement.setAttribute("min", "1");
      numberInputElement.setAttribute("value", value);
      numberInputElement.classList.add("form-control");
      numberInputElement.setAttribute("id", `${id}number`);
      numberInputElement.setAttribute("placeholder", `Enter ${inputDetails.id} # here`);

      const inputElement = document.createElement("input");
      inputElement.setAttribute("type", "text");
      inputElement.setAttribute("value", value);
      inputElement.classList.add("form-control");
      inputElement.setAttribute("id", id);
      inputElement.setAttribute("placeholder", placeholder);

      const helpElement = document.createElement("div");
      helpElement.classList.add("form-text");
      helpElement.classList.add("text-muted");
      helpElement.innerHTML = fieldInfo[id]["help"] + " " + `<a href="${fieldInfo[id]["url"]}" target="_blank">.. learn more</a>`;

      const deleteButton = document.createElement("button");
      deleteButton.classList.add("btn");
      deleteButton.classList.add("btn-outline-secondary");
      deleteButton.setAttribute("type", "button");
      deleteButton.textContent = "X";

      // Add delete functionality
      deleteButton.addEventListener("click", function () {
        formGroup.remove();
      });

      textInputDiv.appendChild(deleteButton);
      textInputDiv.appendChild(numberInputElement);
      textInputDiv.appendChild(inputElement);

      // Append elements to form group
      formGroup.appendChild(labelElement);
      formGroup.appendChild(textInputDiv);
      formGroup.appendChild(helpElement);

      // Append form group to the specified div
      const extraInputsDiv = document.getElementById(extraInputDiv);
      extraInputsDiv.appendChild(formGroup);
    };

    const addOptionalField = fieldName => {
      if (fieldInfo[fieldName] === undefined) {
        return false;
      }
      if (fieldInfo[fieldName].inputs === 2) {
        addNewMultiInput({
          id: fieldName,
          fieldType: "text"
        });
      } else {
        addNewTextInput({
          id: fieldName,
          fieldType: "text"
        });
      }
    };

    const renderFields = () => {
    };

    // Create a map of field id to different properties
    const fieldInfo = {
      // "account": "",
      // "trackingServer": "Tracking Server",
      // "pageName": "Page Name",
      prop: {
        "name": "Prop",
        "help": "Custom variable you can use however you'd like (e.g. Check-out Step 1).",
        "inputs": 2,
        "placeholder": "Enter prop value here",
        "url": "https://experienceleague.adobe.com/docs/analytics/implementation/vars/page-vars/prop.html"
      },
      eVar: {
        "name": "eVar",
        "help": "Captures actions or attributes (e.g. Summer Campaign).",
        "inputs": 2,
        "placeholder": "Enter eVar value here",
        "url": "https://experienceleague.adobe.com/docs/analytics/implementation/vars/page-vars/evar.html"
      },
      events: {
        "name": "Events",
        "help": "Events can be correlated to eVars (e.g. Purchase).",
        "inputs": 1,
        "placeholder": "Enter event string here",
        "url": "https://experienceleague.adobe.com/docs/analytics/implementation/vars/page-vars/events/events-overview.html"
      },
      products: {
        "name": "Products",
        "help": "Tracks products and properties tied to them (e.g. Example category 1;Example product 1;1;3.50).",
        "inputs": 1,
        "placeholder": "Enter product string here",
        "url": "https://experienceleague.adobe.com/docs/analytics/implementation/vars/page-vars/products.html"
      },
      campaign: {
        "name": "Campaign",
        "help": "Collects tracking codes on your site (legacy field and works just like an eVar).",
        "inputs": 1,
        "placeholder": "Enter campaign here",
        "url": "https://experienceleague.adobe.com/docs/analytics/implementation/vars/page-vars/campaign.html"
      }
    };

    let s;


    clearForm = () => {
      document.getElementById("account").value = "";
      document.getElementById("trackingServer").value = "rsid.data.adobedc.net";
      document.getElementById("pageName").value = "Test Page";
      document.getElementById(extraInputDiv).innerHTML = "";
    };

    const sendRequest = () => {

      let account = document.getElementById("account").value;
      s = s_gi(account);
      // If the domain ends with github.io I need to set cookieDomainPeriods to 3
      // because github.io is on the public suffix list.
      // TODO: Remove this when next version of AppMeasurement (2.26.0) is released
      if (window.location.hostname.endsWith("github.io")) {
        s.cookieDomainPeriods = 3;
      }

      // Clear the fields because the tracker might have been used before
      s.clearVars();

      s.trackingServer = document.getElementById("trackingServer").value;
      s.pageName = document.getElementById("pageName").value;

      // Loop through all additional fields (if any)
      const formItems = document.getElementById(extraInputDiv).querySelectorAll("input");
      for (let i = 0; i < formItems.length; i++) {
        const item = formItems[i];
        let id = item.id;
        let value = item.value;
        if (id !== "account" && id !== "trackingServer" && id !== "pageName") {
          // eVars and props has two fields. The number and the value
          if (item.type === "number") {
            i += 1;
            id = formItems[i].id + item.value;
            value = formItems[i].value;
          }
        }
        console.log(id, value);
        s[id] = value;
      }

      // Send the request
      s.t();

      return false;
    };

  </script>

  <br>
  <div class="container-md text-sm-left p-5">
    <h1 class="display-3">AppMeasurement Request Builder</h1>
    <p class="lead">This is a simple tool to help you build and send an AppMeasurement request.</p>
    <hr class="my-4">
    <p>Use this form to specify properties to send to Adobe Analytics.</p>
    <div class="container-sm p-0" >
      <form onsubmit="event.preventDefault(); sendRequest();">
        <div class="mb-3">
          <label for="trackingServer" class="form-label">Tracking Server</label>
          <div class="input-group">
            <input type="text" value="rsid.data.adobedc.net" class="form-control" id="trackingServer"
              placeholder="Tracking Server" required>
          </div>
          <div class="form-text text-muted" id="trackingServerHelp">
            This is the Adobe hosted domain where the request is sent (e.g. metrics.example.com)<a
              href="https://experienceleague.adobe.com/docs/analytics/implementation/vars/config-vars/trackingserversecure.html"
              target="_blank">.. learn more</a>
          </div>
        </div>
        <div class="mb-3">
          <label for="account" class="form-label">Report Suite ID</label>
          <div class="input-group">
            <input type="text" class="form-control" id="account" placeholder="Enter RSID here" required>
          </div>
          <div class="form-text text-muted" id="rsidHelp">
            This is a unique identifier representing a silo of data where the request data is stored (e.g.
            examplereportsuite).<a
              href="https://experienceleague.adobe.com/docs/analytics/admin/admin-tools/manage-report-suites/c-new-report-suite/t-create-a-report-suite.html"
              target="_blank">.. learn more</a>
          </div>
        </div>
        <div class="mb-3">
          <label for="pageName" class="form-label">Page Name</label>
          <div class="input-group">
            <input type="text" value="Test Page" class="form-control" id="pageName" placeholder="Input a page name here">
          </div>
          <div class="form-text text-muted" id="pageNameHelp">
            This is the name of the page that the request is sent from (e.g. Home Page).<a
              href="https://experienceleague.adobe.com/docs/analytics/implementation/vars/page-vars/pagename.html"
              target="_blank">.. learn more</a>
          </div>
        </div>
        <div id="extraInputs">
        </div>
        <br>
        <div class="row g-3">
          <div class="form-group col-sm-5">
            <select class="form-select" id="fieldType">
              <option>Additional optional fields ...</option>
              <option value="prop">Prop</option>
              <option value="eVar">eVar</option>
              <option value="events">Events</option>
              <option value="products">Products</option>
              <!-- <option>Hier</option> -->
              <option value="campaign">Campaign</option>
            </select>
          </div>
          <div class="form-group col-auto">
            <!-- button that triggers a new field creation -->
            <button type="button" class="btn btn-outline-secondary"
              onclick="addOptionalField(document.getElementById('fieldType').value)">Add Field</button>
          </div>
        </div>
        <br>
        <button type="submit" class="btn btn-primary">Send Request</button>
        <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
      </form>
    </div>
  </div>

</body>

</html>